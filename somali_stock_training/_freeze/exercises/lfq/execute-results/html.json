{
  "hash": "23f9a85ff02faf3c7b3dd704d600faab",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Length-Frequency Analysis for Stock Assessment\"\nsubtitle: \"Selected species of tuna and tuna-like fish in Somalia Water\"\nauthor: \"Rushingisha George, Masumbuko Semba, and Mathew Silas\"\nformat: html\ndate: \"2025-12-16\"\ndate-modified: today\ntoc: true\nlot: true\nlof: true\nembed-resources: true\nexecute: \n  echo: true\n  error: false\n  comment: \"\"\n  warning: false\n  message: false\n\ncode-fold: show\n---\n\n\n\n\n**What we're doing:** Load the R packages required for length-frequency analysis and stock assessment.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load required libraries\nlibrary(tidyverse)      # Data manipulation and visualization\nlibrary(sizeMat)        # For maturity analysis\nlibrary(gt)             # For professional tables\nrequire(TropFishR)      # Tropical fisheries stock assessment\n```\n:::\n\n\n\n\n# Introduction\n\nThis document provides a step-by-step guide to analyzing length-frequency (LFQ) data for commercially important fish species in Somalia using the `TropFishR` package. Length-frequency analysis is a fundamental method in fisheries science for understanding population structure, growth, and mortality.\n\nThe exercise will proceed as follows:\n\n1. Load and prepare the length-weight data.\n2. Use `TropFishR` functions to create a length-frequency object.\n3. Modify and restructure the LFQ data for visualization and analysis.\n4. Plot raw and restructured data to identify growth and recruitment patterns.\n\n# Method\n\n## Data Preparation\n\n**What we're doing:** Load the fisheries dataset containing length, weight, species, and date information.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlw = read_csv(\"lw2.csv\")\n```\n:::\n\n\n\n\n### Identify Species with Sufficient Data\n\n**What we're doing:** Filter for fish species with at least 200 recorded individuals to ensure statistical reliability.\n\n**Why it matters:** Species with few observations may have unreliable estimates. Focus on well-sampled species improves analysis quality.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfishes = lw |> \n  group_by(fish_type_code) |> \n  tally() |> \n  arrange(desc(n)) |> \n  filter(n > 200) |> \n  pull(fish_type_code)\n\n# Use these key tuna and mackerel species\nfishes = c(\"YFT\", \"SKJ\", \"KAW\", \"JAC\", \"LOT\", \"MAH\", \"SCH\", \"BET\")\n```\n:::\n\n\n\n\n### Create Species Reference Table\n\n**What we're doing:** Build a lookup table mapping FAO species codes to common and scientific names.\n\n**Why it matters:** Clear species identification is essential for communicating results to stakeholders and ensuring accurate interpretation.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfish_name <- tibble(\n  FAO_Code = c(\"YFT\", \"SKJ\", \"KAW\", \"JAC\", \"LOT\", \"MAH\", \"SCH\", \"BET\"),\n  English_Name = c(\"Yellowfin tuna\", \"Skipjack tuna\", \"Kawakawa\", \"Jack mackerel\", \n                   \"Longtail tuna\", \"Mahi-mahi\", \"Chub mackerel\", \"Bigeye tuna\"),\n  Scientific_Name = c(\"Thunnus albacares\", \"Katsuwonus pelamis\", \"Euthynnus affinis\", \n                      \"Trachurus spp.\", \"Thunnus tonggol\", \"Coryphaena hippurus\", \n                      \"Scomber japonicus\", \"Thunnus obesus\")\n)\n\nfish_name\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 8 × 3\n  FAO_Code English_Name   Scientific_Name    \n  <chr>    <chr>          <chr>              \n1 YFT      Yellowfin tuna Thunnus albacares  \n2 SKJ      Skipjack tuna  Katsuwonus pelamis \n3 KAW      Kawakawa       Euthynnus affinis  \n4 JAC      Jack mackerel  Trachurus spp.     \n5 LOT      Longtail tuna  Thunnus tonggol    \n6 MAH      Mahi-mahi      Coryphaena hippurus\n7 SCH      Chub mackerel  Scomber japonicus  \n8 BET      Bigeye tuna    Thunnus obesus     \n```\n\n\n:::\n:::\n\n\n\n\n### Inspect Dataset Structure\n\n**What we're doing:** Display the column names and data types in the dataset.\n\n**What to look for:** Ensure date, length, weight, and species columns are present and correctly formatted.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlw |> \n    glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 3,571\nColumns: 19\n$ boat_id              <dbl> 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3…\n$ catch_id             <dbl> 1, 1, 1, 1, 1, 3, 7, 7, 7, 4, 4, 5, 5, 5, 9, 9, 9…\n$ fish_id              <dbl> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15…\n$ date_dd_mm_yy        <dttm> 2018-11-02, 2018-11-02, 2018-11-02, 2018-11-02, …\n$ year                 <dbl> 2018, 2018, 2018, 2018, 2018, 2018, 2018, 2018, 2…\n$ month                <chr> \"Nov\", \"Nov\", \"Nov\", \"Nov\", \"Nov\", \"Nov\", \"Nov\", …\n$ day                  <dbl> 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2…\n$ region               <chr> \"Mogadishu\", \"Mogadishu\", \"Mogadishu\", \"Mogadishu…\n$ landing_site         <chr> \"Lido Beach\", \"Lido Beach\", \"Lido Beach\", \"Lido B…\n$ vessel_id            <dbl> 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3…\n$ fish_type_code       <chr> \"YFT\", \"YFT\", \"YFT\", \"YFT\", \"YFT\", \"MAH\", \"OTH1\",…\n$ fish_index           <dbl> 1, 2, 3, 4, 5, 1, 1, 2, 3, 1, 2, 1, 2, 3, 1, 2, 3…\n$ weight_kg            <dbl> 7.7, 3.6, 4.5, 4.5, 3.2, 9.5, 2.3, 3.2, 2.3, 11.0…\n$ length_cm            <dbl> 76, 59, 65, 67, 61, 124, 55, 64, 55, 84, 85, 62, …\n$ fish_group           <chr> \"Tuna\", \"Tuna\", \"Tuna\", \"Tuna\", \"Tuna\", \"Other\", …\n$ notes                <chr> NA, NA, NA, NA, NA, NA, \"Aarjoog\", \"Aarjoog\", \"Aa…\n$ kobo_section_1_index <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ kobo_section_2_index <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ kobo_section_3_index <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n```\n\n\n:::\n:::\n\n\n\n\n## Fish Groups Analysis\n\nIn the following sections, we will perform length-frequency analysis for several key tuna and mackerel species. For each species, we filter the data and convert it into a structured length-frequency format suitable for growth and mortality analyses.\n\n### Yellowfin Tuna Example\n\n**What we're doing:** Filter the main dataset to create a subset containing only Yellowfin Tuna (YFT) observations.\n\n**Why start here:** Yellowfin is a well-studied species with good sample sizes, making it ideal for demonstrating the analysis workflow.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nyft = lw |> \n    filter(fish_type_code == 'YFT')\n```\n:::\n\n\n\n\n## LFQ Creation\n\n**What we're doing:** Convert raw individual fish length measurements into a length-frequency object using the `lfqCreate()` function.\n\n**The process:**\n1. Standardize dates to a proper date format\n2. Aggregate measurements into 2 cm length bins\n3. Group by sampling date to create a time series\n4. Create an `lfq` object ready for further analysis\n\n**Why it matters:** LFQ objects organize data into the standardized format required by growth and mortality estimation methods.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nyft_lfq = yft |>\n   mutate(\n    date = as_date(date_dd_mm_yy)\n    ) |> \n  TropFishR::lfqCreate(\n    Lname = \"length_cm\",       # Column name for lengths\n    Dname = \"date\",            # Column name for dates\n    bin_size = 2,              # 2 cm length bins\n    species = \"Yellowfin\", \n    length_unit = \"cm\", \n    aggregate_dates = TRUE\n    )\n```\n:::\n\n\n\n\n## LFQ Modification and Restructuring\n\n**What we're doing:** Process the LFQ object to improve visualization of cohort progression:\n1. Aggregate samples into monthly groups (rather than daily)\n2. Increase length bin size to 5 cm for clearer visualization\n3. Apply moving average smoothing (11-month window) to reduce noise\n4. Apply square-root transformation to stabilize variance\n\n**Why each step matters:**\n- **Monthly aggregation:** Reduces noise from daily variation\n- **5 cm bins:** Easier to visualize growth patterns\n- **Moving average:** Highlights cohort trajectories by smoothing random fluctuations\n- **Square-root transformation:** Large catches don't visually dominate small catches\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nyft_lfq_mod = yft_lfq |> \n  TropFishR::lfqModify(\n    bin_size = 5,              # Wider length bins\n    aggregate = \"month\",       # Monthly aggregation\n    vectorise_catch = FALSE\n    ) |> \n  TropFishR::lfqRestructure(\n    MA = 11,                   # 11-month moving average\n    addl.sqrt = TRUE           # Square-root transformation\n    )\n```\n:::\n\n\n\n\n### Plot Restructured Length-Frequency Data\n\n**What we're doing:** Visualize the processed length-frequency data as a contour or heatmap showing how fish sizes change over time.\n\n**What to look for:**\n- **Diagonal bands:** Show cohorts (same-aged groups) growing through size classes\n- **Modal length:** The most common size in each time period\n- **Recruitment pulses:** New fish entering the fishery (smallest sizes)\n- **Gaps:** May indicate periods of low recruitment or high fishing on young fish\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow = c(1,1))\n\nyft_lfq_mod |> \n  plot(\n    Fname = \"catch\",           # Use restructured counts\n    las = 1,\n    ylab = 'Length classes (cm)',\n    cex.main = 1.5,\n    cex.lab = 1.2,\n    cex.axis = 1\n  )\n```\n\n::: {.cell-output-display}\n![](lfq_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n\n## Summary for All Species\n\n**What we're doing:** Automate the entire LFQ workflow for all selected species using a loop.\n\n**Workflow for each species:**\n1. Filter data for that species\n2. Standardize dates to 2024 (keep original month)\n3. Create LFQ object with 2 cm bins\n4. Modify to monthly bins with 5 cm length classes\n5. Restructure with 9-month moving average and square-root transformation\n6. Plot the results\n\n**Why standardize to one year:** Allows easy visual comparison of seasonal patterns across species by plotting the annual cycle.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfor (j in 1:length(fishes)){  \n\n    readline(prompt = 'Press ENTER to see next species')\n\n    aa = lw |> \n        filter(fish_type_code == fishes[j]) |>\n        mutate(\n            # Standardize all dates to 2024 while keeping original month\n            date = lubridate::make_date(year = 2024, month = month(date_dd_mm_yy), day = 15)\n        )\n    \n    # Calculate length range for consistent axis limits\n    bb = aa |> pull(length_cm) |> quantile(c(0.01, 0.99), na.rm = TRUE)\n\n    aa |> \n      TropFishR::lfqCreate(\n        Lname = \"length_cm\", \n        Dname = \"date\", \n        bin_size = 2, \n        species = fish_name$English_Name[j],\n        length_unit = \"cm\", \n        aggregate_dates = TRUE\n        ) |> \n      TropFishR::lfqModify(\n        bin_size = 4, \n        aggregate = \"month\", \n        vectorise_catch = FALSE\n        ) |> \n      TropFishR::lfqRestructure(\n        MA = 9, \n        addl.sqrt = TRUE\n        ) |> \n        plot(        \n            Fname = \"catch\", \n            las = 1, \n            ylim = bb,\n            main = paste0(fish_name$English_Name[j], \" (\", fish_name$Scientific_Name[j], \")\"),\n            ylab = 'Length classes (cm)',\n            cex.main = 1.5,\n            cex.lab = 1.2,\n            cex.axis = 1\n        )\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPress ENTER to see next species\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lfq_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPress ENTER to see next species\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lfq_files/figure-html/unnamed-chunk-10-2.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPress ENTER to see next species\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lfq_files/figure-html/unnamed-chunk-10-3.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPress ENTER to see next species\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lfq_files/figure-html/unnamed-chunk-10-4.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPress ENTER to see next species\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lfq_files/figure-html/unnamed-chunk-10-5.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPress ENTER to see next species\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lfq_files/figure-html/unnamed-chunk-10-6.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPress ENTER to see next species\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lfq_files/figure-html/unnamed-chunk-10-7.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPress ENTER to see next species\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lfq_files/figure-html/unnamed-chunk-10-8.png){width=672}\n:::\n:::\n\n\n\n\n## Bonus Information: Alternative LFQ Packages\n\nLength-Frequency analysis is essential in data-limited fisheries. While `TropFishR` is comprehensive and implements the ELEFAN method, other R packages offer complementary approaches for length-based stock assessment.\n\n### `fishdynr` Package\n\n**Purpose:** Alternative implementation of FiSAT II methods for LFQ analysis with a slightly different workflow.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Example: fishdynr workflow\"}\nlibrary(fishdynr)\n\n# Prepare data: fishdynr requires 'date' and 'length' columns\nyft_for_fishdynr <- yft |>\n  select(date = date_dd_mm_yy, length = length_cm) |>\n  mutate(date = as.Date(date, format = \"%d-%m-%Y\"))\n\n# Create LFQ object and plot\nyft_lfq_fd <- lfq(dat = yft_for_fishdynr, bin_size = 4)\nplot(yft_lfq_fd, hist.sc = 0.5)\n```\n:::\n\n\n\n\n### `LBSPR` Package\n\n**Purpose:** Estimate Spawning Potential Ratio (SPR)—a key indicator of stock health—using length data and basic life history parameters.\n\n**Advantages:** Simpler than ELEFAN; directly estimates current stock status relative to management reference points.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Example: LBSPR workflow\"}\nlibrary(LBSPR)\n\n# 1. Set up life history parameters\nMyPars <- new(\"LB_pars\", L_units = \"cm\")\nMyPars@Linf <- 170      # Asymptotic length (from literature)\nMyPars@L50 <- 105       # Length at 50% maturity\nMyPars@L95 <- 120       # Length at 95% maturity\nMyPars@MK <- 1.5        # Natural Mortality / Growth rate ratio\n\n# 2. Create length data object from your observations\nMyLengths <- new(\"LBSPRlen\", Len = yft$length_cm, LData = MyPars)\n\n# 3. Fit the model\nLBSPR_fit <- LBSPRfit(MyPars, MyLengths)\n\n# 4. Plot results showing stock status\nplot(LBSPR_fit)\n```\n:::\n\n\n\n\n**Key advantage:** LBSPR directly tells you if a stock is overfished (SPR too low) or healthy (SPR adequate), making it ideal for management advice.\n\n",
    "supporting": [
      "lfq_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}