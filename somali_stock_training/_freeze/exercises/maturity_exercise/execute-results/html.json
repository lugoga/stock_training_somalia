{
  "hash": "4a87739e98a808a9e689c147c788e5ce",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Exercise: Estimating Length at 50% Maturity (L50)\"\nsubtitle: \"A step-by-step guide using the `sizeMat` package\"\nformat: html\nexecute:\n  eval: true\n  echo: true\n  warning: false\ncode-fold: false\n---\n\n\n\n\n## Introduction\n\nThis exercise will guide you through the process of estimating the length at 50% maturity (L50) for Yellowfin Tuna (YFT) using data from Somali landing sites. We will use the `sizeMat` package in R, which provides tools for this type of analysis, especially in data-limited situations where direct gonad staging data is not available.\n\nThe `sizeMat` package can infer maturity by identifying different morphometric groups (juveniles and adults) within the length and weight data.\n\n## Step 1: Setup\n\nFirst, we need to load the R packages that we will use for this analysis. We need `tidyverse` for data manipulation, `sizeMat` for the maturity analysis, and `gt` to create well-formatted tables.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load required libraries\nlibrary(tidyverse)\nlibrary(sizeMat) # For maturity analysis\nlibrary(gt)      # For nice tables\n```\n:::\n\n\n\n\n## Step 2: Load and Prepare Data\n\nNext, we will load the fish landing data from the `lw2.csv` file. This dataset contains length and weight measurements for various species. We will then filter this data to create a dataset that only contains records for Yellowfin Tuna (YFT) and has complete length and weight information.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlw = readxl::read_excel('../data_shared/ProjKalluun_master_data_entry.xlsx', sheet = 'Section 3', skip= 4) |> \n    janitor::clean_names() |> \n    filter(!is.na(landing_site))\n\nlw = lw |> \n mutate(\n    year = year(date_dd_mm_yy),\n    month = month(date_dd_mm_yy, label = TRUE),\n    day = day(date_dd_mm_yy), \n    .after = date_dd_mm_yy\n ) |> \n    mutate(\n    weight_kg = as.numeric(weight_kg),\n    length_cm = as.numeric(length_cm)\n    )\n\n# lw |> write_csv('../data_shared/lw2.csv')\n\nyft = lw |> filter(fish_type_code == 'YFT')\n```\n:::\n\n\n\n\n## Step 3: Classify Maturity using Morphometrics\n\nSince we don't have visual gonad staging data, we will use the `classify_mature()` function from the `sizeMat` package. This function uses a statistical method (`\"ld\"` for linear discriminant analysis) to find two groups in the length-weight data, which it classifies as \"juvenile\" and \"adult\".\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\n## Partitioning with Frequentist regression \nclassified_yft <- yft |> \n  classify_mature(\n    varNames = c(\"length_cm\", \"weight_kg\"),\n    varSex = NULL, \n    selectSex = NULL,\n    method = \"ld\"\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nall individuals were used in the analysis \n```\n\n\n:::\n:::\n\n\n\n\nThe function has now added a `maturity` column to our dataset. Let's inspect the result.\n\n\nWe can visualize how the function has classified the fish by plotting the length-weight relationship and coloring the points by the new `maturity` status.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclassified_yft |> \n  plot(\n    main = 'L50 of Yellowfin',\n    xlab = 'Length (cm)', \n    ylab = 'Weight (kg)',\n     cex.main = 1.5,\n     cex.lab = 1.2,\n     cex.axis = 1\n  )\n```\n\n::: {.cell-output-display}\n![Length-weight relationship of Yellowfin Tuna, colored by maturity status.](maturity_exercise_files/figure-html/plot-classification-1.png){width=672}\n:::\n:::\n\n\n\n\n## Step 4: Estimate L50\n\nNow that we have classified each fish as either juvenile (0) or adult (1), we can model the probability of being mature at a given length. The `morph_mature()` function fits a logistic curve to this binary data and estimates the parameters of the maturity ogive, including L50.\n\nWe will use the frequentist method (`method = \"fq\"`) and run 1000 bootstrap iterations (`niter = 1000`) to get confidence intervals for our estimates.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_ogive_fq <- morph_mature(\n    data = classified_yft, \n    method = \"fq\", \n    niter = 1000\n)\n```\n:::\n\n\n\n\n## Step 5: Interpret the Results\n\nThe `morph_mature` function returns an object containing the estimated parameters. We can print this object to see the results.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# The print() function for this object is a bit verbose, so we capture and reformat it.\nmy_ogive_tb <- my_ogive_fq |> \n    print() |> \n    as.data.frame() |> \n    as_tibble() |> \n    mutate(Freq = as.numeric(Freq)) |> \n    pivot_wider(names_from = Var1, values_from = Freq)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nformula: Y = 1/1+exp-(A + B*X) \n```\n\n\n:::\n\n```{.r .cell-code}\nmy_ogive_tb |> \n  gt() |> \n  fmt_number(columns = everything(), decimals = 2) |>\n  tab_header(title = \"Maturity Ogive Parameters for Yellowfin Tuna\")\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"dloajhaqwz\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#dloajhaqwz table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#dloajhaqwz thead, #dloajhaqwz tbody, #dloajhaqwz tfoot, #dloajhaqwz tr, #dloajhaqwz td, #dloajhaqwz th {\n  border-style: none;\n}\n\n#dloajhaqwz p {\n  margin: 0;\n  padding: 0;\n}\n\n#dloajhaqwz .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#dloajhaqwz .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#dloajhaqwz .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#dloajhaqwz .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#dloajhaqwz .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#dloajhaqwz .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#dloajhaqwz .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#dloajhaqwz .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#dloajhaqwz .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#dloajhaqwz .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#dloajhaqwz .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#dloajhaqwz .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#dloajhaqwz .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#dloajhaqwz .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#dloajhaqwz .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#dloajhaqwz .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#dloajhaqwz .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#dloajhaqwz .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#dloajhaqwz .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#dloajhaqwz .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#dloajhaqwz .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#dloajhaqwz .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#dloajhaqwz .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#dloajhaqwz .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#dloajhaqwz .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#dloajhaqwz .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#dloajhaqwz .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#dloajhaqwz .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#dloajhaqwz .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#dloajhaqwz .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#dloajhaqwz .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#dloajhaqwz .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#dloajhaqwz .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#dloajhaqwz .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#dloajhaqwz .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#dloajhaqwz .gt_left {\n  text-align: left;\n}\n\n#dloajhaqwz .gt_center {\n  text-align: center;\n}\n\n#dloajhaqwz .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#dloajhaqwz .gt_font_normal {\n  font-weight: normal;\n}\n\n#dloajhaqwz .gt_font_bold {\n  font-weight: bold;\n}\n\n#dloajhaqwz .gt_font_italic {\n  font-style: italic;\n}\n\n#dloajhaqwz .gt_super {\n  font-size: 65%;\n}\n\n#dloajhaqwz .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#dloajhaqwz .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#dloajhaqwz .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#dloajhaqwz .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#dloajhaqwz .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#dloajhaqwz .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#dloajhaqwz .gt_indent_5 {\n  text-indent: 25px;\n}\n\n#dloajhaqwz .katex-display {\n  display: inline-flex !important;\n  margin-bottom: 0.75em !important;\n}\n\n#dloajhaqwz div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {\n  height: 0px !important;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_heading\">\n      <td colspan=\"5\" class=\"gt_heading gt_title gt_font_normal gt_bottom_border\" style>Maturity Ogive Parameters for Yellowfin Tuna</td>\n    </tr>\n    \n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Var2\">Var2</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"A\">A</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"B\">B</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"L50\">L50</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"R2\">R2</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"Var2\" class=\"gt_row gt_center\">Original</td>\n<td headers=\"A\" class=\"gt_row gt_right\">−29.37</td>\n<td headers=\"B\" class=\"gt_row gt_right\">0.31</td>\n<td headers=\"L50\" class=\"gt_row gt_right\">94.30</td>\n<td headers=\"R2\" class=\"gt_row gt_right\">0.89</td></tr>\n    <tr><td headers=\"Var2\" class=\"gt_row gt_center\">Bootstrap (Median)</td>\n<td headers=\"A\" class=\"gt_row gt_right\">−29.94</td>\n<td headers=\"B\" class=\"gt_row gt_right\">0.32</td>\n<td headers=\"L50\" class=\"gt_row gt_right\">94.25</td>\n<td headers=\"R2\" class=\"gt_row gt_right\">NA</td></tr>\n  </tbody>\n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\n\n\n**Interpretation of the table:**\n\n-   **A and B**: These are the intercept and slope parameters for the logistic regression model: `Y = 1 / (1 + exp(-(A + B*X)))`.\n-   **L50**: This is the estimated length at which 50% of the population is mature. This is our key result.\n-   **R2**: The coefficient of determination, indicating how well the model fits the data.\n-   **Bootstrap (Median)**: These are the median values from the 1000 bootstrap runs, which give a more robust estimate of the parameters.\n\nBased on this analysis, the estimated L50 for Yellowfin Tuna is **94.3 cm**.\n\n### Visualize the Maturity Ogive\n\nFinally, we can plot the maturity ogive, which is the S-shaped curve showing the proportion of mature fish at each length.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_ogive_fq |> \n    plot(\n    main = 'L50 of Yellowfin',\n    xlab = 'Length (cm)', \n    ylab = 'Proportion Mature',\n    cex.main = 1.5,\n    cex.lab = 1.2,\n    cex.axis = 1\n)\n```\n\n::: {.cell-output-display}\n![Maturity ogive for Yellowfin Tuna, showing the proportion of mature individuals by length.](maturity_exercise_files/figure-html/plot-ogive-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![Maturity ogive for Yellowfin Tuna, showing the proportion of mature individuals by length.](maturity_exercise_files/figure-html/plot-ogive-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![Maturity ogive for Yellowfin Tuna, showing the proportion of mature individuals by length.](maturity_exercise_files/figure-html/plot-ogive-3.png){width=672}\n:::\n\n::: {.cell-output-display}\n![Maturity ogive for Yellowfin Tuna, showing the proportion of mature individuals by length.](maturity_exercise_files/figure-html/plot-ogive-4.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSize at morphometric maturity = 94.3 \nConfidence intervals = 92.4 - 96.5 \nRsquare = 0.89\n```\n\n\n:::\n:::\n\n\n\n\nThe plot shows the observed proportion of mature fish at each length class (black dots) and the fitted logistic curve (solid line). The dashed lines indicate the estimated L50.\n\n## Exercise Questions\n\n1.  What does the L50 value of 94.3 cm mean for the management of Yellowfin Tuna in Somalia?\n2.  The `classify_mature` function can also use a `\"gmm\"` (Gaussian Mixture Model) method. Try re-running the analysis with `method = \"gmm\"`. Does the estimated L50 change significantly?\n3.  This analysis was done on all Yellowfin Tuna data combined. How might you adapt this script to see if L50 differs between regions (e.g., 'Berbera' vs. 'Mogadishu')?\n",
    "supporting": [
      "maturity_exercise_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}